window.AmeItemAccessEditor=function(e){"use strict";var t,a,s,i,n,o,r,c,l=!1,_=null,p=!1,d="",u=null,m=null,y=!0,g=null,w=null,f=!1,h={},b=390;function x(t){m=t||null,_.removeClass("ws_cpt_selected_role"),m&&(_.filter(function(){return e(this).data("actor")===m}).addClass("ws_cpt_selected_role"),o.find(".ws_aed_selected_actor_name").text(s.getNiceName(AmeActors.getActor(m)))),f&&C()}function C(){f&&w.find('tr td.ws_ext_action_check_column input[type="checkbox"]').each(function(){var t=e(this),a=g.capabilities[t.data("ext_action")],s=AmeCapabilityManager.hasCap(m,a,h),i=AmeCapabilityManager.hasCapByDefault(m,a);t.prop("checked",s),t.closest("tr").toggleClass("ws_ext_has_custom_setting",s!==i)})}function v(e){e=e||"",/^[\w\-]+?\.php/.test(e)&&(e="/wp-admin/"+e);var a=k(e);if(t.includes(["edit.php","post-new.php","edit-tags.php"],a.file)){var s=t.get(a,"queryKey.taxonomy",null),o=t.get(a,"queryKey.post_type",null);if(s&&n.hasOwnProperty(s))return t.assign({},n[s],{type:"taxonomy",objectKey:s});if(o&&i.hasOwnProperty(o))return t.assign({},i[o],{type:"post_type",objectKey:o});if("edit-tags.php"===a.file&&n.hasOwnProperty("category"))return t.assign({},t.get(n,"category"),{type:"taxonomy",objectKey:"category"});if(i.hasOwnProperty("post"))return t.assign({},t.get(i,"post"),{type:"post_type",objectKey:"post"})}return null}function k(e){for(var t=k.options,a=t.parser[t.strictMode?"strict":"loose"].exec(e),s={},i=14;i--;)s[t.key[i]]=a[i]||"";return s[t.q.name]={},s[t.key[12]].replace(t.q.parser,function(e,a,i){a&&("queryKey"===t.q.name&&(a=decodeURIComponent(a),i=decodeURIComponent(i)),s[t.q.name][a]=i)}),s}return k.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},e(document).ready(function(){(o=e("#ws_menu_access_editor")).on("click",".ws_role_table_body tr",function(){f&&x(e(this).closest("tr").data("actor"))}),o.on("click","#ws_ext_toggle_capability_names",function(){y=!y,e("#ws_ext_permissions_container").toggleClass("ws_ext_readable_names_enabled",y),e.cookie("ame-readable-capability-names",y?"1":"0",{expires:90})}),o.on("click",".ws_column_role label",function(e){f&&e.preventDefault()}),o.find(".ws_ext_permissions_table").on("change","input.ws_ext_action_allowed",function(){if(f){var t,a=e(this),s=a.prop("checked"),i=g.capabilities[a.data("ext_action")];AmeCapabilityManager.resetCapInContext(h,m,i),s!==AmeCapabilityManager.hasCap(m,i,h)&&AmeCapabilityManager.setCapInContext(h,m,i,s,g.type,g.objectKey),i===d&&(t=m,_.filter(function(){return e(this).data("actor")===t})).find("input.ws_role_access").prop("checked",s),C()}}),o.find(".ws_role_table_body").on("change","input.ws_role_access",function(){if(f&&d){var t=e(this).prop("checked"),a=AmeCapabilityManager.hasCap(m,d,h),s=AmeCapabilityManager.hasCapByDefault(m,d);t&&s&&!a&&(AmeCapabilityManager.setCapInContext(h,m,d,!0,g.type,g.objectKey),C())}}),o.find("#ws_save_access_settings").click(function(){var t,s,i;t=a.jsTrim(e("#ws_extra_capability").val())||null,s=e("#ws_restrict_access_to_items").prop("checked"),i=e.extend({},c.grant_access),_.each(function(){var t=e(this);i[t.data("actor")]=t.find("input.ws_role_access").prop("checked")}),r&&r(c,u,{extraCapability:t,grantAccess:i,restrictAccessToItems:s,grantedCapabilities:h}),o.dialog("close")})}),{setup:function(o){t=o.lodash,a=o.api,s=o.actorSelector,i=o.postTypes,n=o.taxonomies,r=o.save||null,l=t.get(o,"isPro",!1),y=void 0===(y=e.cookie("ame-readable-capability-names"))||"1"===y},open:function(i){c=i.menuItem,u=i.containerNode,h={},p||((o=o||e("#ws_menu_access_editor")).dialog({autoOpen:!1,closeText:" ",modal:!0,minHeight:100,width:b,draggable:!1}),o.find("label.ws_ext_action_name").wrapInner('<span class="ws_ext_readable_name"></span>').append('<span class="ws_ext_capability"></span>'),o.find("#ws_ext_permissions_container").toggleClass("ws_ext_readable_names_enabled",y),p=!0),d=a.getFieldValue(c,"access_level","Error: access_level is missing!");var n=o.find("#ws_required_capability").empty();""===c.template_id?n.append("<em>None</em>"):n.text(d),o.find("#ws_extra_capability").val(a.getFieldValue(c,"extra_capability","")),o.find("#ws_restrict_access_to_items").prop("checked",a.getFieldValue(c,"restrict_access_to_items",!1));for(var r=o.find(".ws_role_table_body tbody").empty(),m="",C=s.getVisibleActors(),k=0;k<C.length;k++){var A=C[k],M="allow_"+A.id.replace(/[^a-zA-Z0-9_]/g,"_"),q=e('<input type="checkbox">').addClass("ws_role_access").attr("id",M),I=a.actorCanAccessMenu(c,A.id);q.prop("checked",I),m=""===m?"alternate":"";var K=e("<tr>").data("actor",A.id).attr("class",m).append(e("<td>").addClass("ws_column_access").append(q),e("<td>").addClass("ws_column_role post-title").append(e("<label>").attr("for",M).append(e("<span>").text(s.getNiceName(A)))),e("<td>").addClass("ws_column_selected_role_tip").append(e("<div></div>").addClass("ws_cpt_selected_role_tip")));r.append(K)}_=r.find("tr"),o.find("#ws_item_restriction_container").toggle(i.itemHasSubmenus),e("#ws_hardcoded_role_error").toggle(AmeCapabilityManager.roleExists(d)),e("#ws_hardcoded_role_name").text(d),g=l?v(a.getItemDisplayUrl(c)):null,f=!!g;var j=e("#ws_ext_permissions_container");if(f){if(j.show(),o.find(".ws_ext_permissions_table").hide(),w=o.find("#ws_"+g.type+"_permissions_table").show(),j.find("#ws_ext_selected_object_type_name").text(g.title),"post_type"===g.type){var N=t.get(g,"capabilities.create_posts"),P=t.get(g,"capabilities.edit_posts");e("#ws_cpt_action-create_posts").closest("tr").toggle(N!==P)}t.forEach(t.get(g,"capabilities",[]),function(e,t){var a=e;e===d&&(a+=" (The required capability for this menu item.)"),w.find("tr.ws_ext_action-"+t+" label.ws_ext_action_name").attr("title",a).toggleClass("ws_same_as_required_cap",e===d).find(".ws_ext_capability").text(e)})}else j.hide(),w=null;o.dialog("open");var E=f?755:b;if(o.dialog("option","width")!==E&&o.dialog("option","width",E),f){x(i.selectedActor||C[0].id||null);var O=o.find(".ws_role_table_body").height()-w.height(),T=w.find(".ws_ext_padding_row td"),D=T.height();Math.abs(O)>=1&&T.height(Math.max(O+D,1))}else x(null);e("#ws_role_access_container").toggleClass("ws_has_extended_permissions",f)},getCurrentMenuItem:function(){return c},detectExtPermissions:v}}(jQuery);